{{ ansible_managed | comment('cblock') }}
# satellite {{ ansible_fqdn }}
# master_ip {{ icinga2_master }}

{% set satellite_ip = lookup('pipe', 'host ' + ansible_fqdn   + ' | grep "has address" | cut -d" " -f4') %}
{% set master_ip    = lookup('pipe', 'host ' + icinga2_master + ' | grep "has address" | cut -d" " -f4') %}
/*
 * Generated by Icinga 2 node setup commands
 */
{% if icinga2_mode == 'master' %}
// Icinga2 master {{ icinga2_master }} - {{ master_ip }}
object Endpoint "{{ icinga2_certificate_cn }}" {
{% if ipaddr.stdout is defined %}
  host = "{{ ipaddr.stdout }}"
{% endif %}
  port = "5665"
}
//this is the local node master named  = "master"
/*
object Zone "{{ icinga2_certificate_cn }}" { endpoints = [ "{{ icinga2_certificate_cn }}" ] }*/
object Zone "master" { endpoints = [ "{{ icinga2_certificate_cn }}" ] }
{% endif %}

{% if icinga2_mode == 'satellite' %}
{% if __satellite_api_connections is defined and __satellite_api_connections.stat.exists == false %}
object Endpoint NodeName { port = "5665" }
object Zone NodeName { parent = "{{ icinga2_master }}" ; endpoints = [ NodeName ] }
{% endif %}
object Endpoint "{{ icinga2_master }}" { host = "{{ icinga2_master }}" ; port = "5665" }
//this is the local node master named  = "master"
object Zone "{{ icinga2_master }}" { endpoints = [ "{{ icinga2_master }}" ] }
{% endif %}

object Zone "global-templates" { global = true }
